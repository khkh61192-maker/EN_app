<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vocab Pro - ç©©å®šå­¸ç¿’ç‰ˆ</title>
    <!-- 
      DEVELOPER NOTES / æŠ€è¡“äº¤æ¥æ‰‹å†Š:
      1. æ ¸å¿ƒæŠ€è¡“æ£§: 
         - Dexie.js: IndexedDB çš„å°è£åº«ï¼Œè² è²¬ 4000+ å–®å­—çš„æ°¸ä¹…å„²å­˜ã€‚
         - SheetJS (xlsx): è² è²¬ Excel åŒ¯å…¥èˆ‡å‚™ä»½å°å‡ºã€‚
         - Tailwind CSS: UI æ¡†æ¶ã€‚
         - Web Speech API: ç€è¦½å™¨åŸç”Ÿ TTS ç™¼éŸ³ã€‚
      2. å„²å­˜æ¶æ§‹:
         - è³‡æ–™åº«å: VocabProDB
         - è¡¨å: words (ç´¢å¼•: Word, Group)
      3. å·²çŸ¥é™åˆ¶:
         - æ‰‹æ©ŸèƒŒæ™¯æ’­æ”¾: ç”±æ–¼ç€è¦½å™¨çœé›»æ©Ÿåˆ¶ï¼Œåˆ‡æ› App æˆ–é–å±å¾Œ JavaScript é€šå¸¸æœƒè¢«æš«åœã€‚
         - ç™¼éŸ³ä¾è³´: ä¾è³´ç³»çµ±å…§å»ºèªéŸ³åŒ…ï¼ŒiOS èˆ‡ Android çš„è²éŸ³è¡¨ç¾å¯èƒ½ä¸åŒã€‚
      4. æœªä¾†å„ªåŒ–æ–¹å‘: 
         - å¢åŠ ã€Œå­¸ç¿’é€²åº¦ã€æ¬„ä½ (å¦‚: å·²ç†Ÿç·´/å¾…åŠ å¼·)ã€‚
         - å°å…¥ Web Worker è™•ç†å¤§é‡æ•¸æ“šé‹ç®—ä»¥é˜² UI å¡é “ã€‚
    -->
    <script src="https://cdn.jsdelivr.net/npm/dexie@3/dist/dexie.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .preserve-format { white-space: pre-wrap; word-break: break-word; }
        .active-word { background-color: #fef3c7; border-left: 6px solid #f59e0b; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .word-card { transition: all 0.2s ease-out; }
        html { scroll-behavior: smooth; }
        /* é®ç½©å±¤æ¨£å¼ */
        #historyModal { display: none; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen pb-24 font-sans text-slate-800">

<div class="max-w-2xl mx-auto p-4">
    <!-- é ‚éƒ¨æ§åˆ¶é¢æ¿ -->
    <header class="sticky top-0 bg-white/95 backdrop-blur shadow-md p-4 rounded-b-2xl z-30 mb-2 border-b border-slate-200">
        <div class="flex justify-between items-start mb-4">
            <div>
                <h1 class="text-xl font-black text-blue-600 flex items-center gap-2">
                    Vocab Pro 
                    <span id="versionTag" class="text-[10px] bg-slate-200 text-slate-500 px-2 py-0.5 rounded-full cursor-pointer hover:bg-blue-100 hover:text-blue-600 transition-colors">v1.1.0</span>
                </h1>
                <p id="totalCount" class="text-[10px] text-slate-400 font-bold tracking-widest mt-1 uppercase italic">é€£ç·šè³‡æ–™åº«ä¸­...</p>
            </div>
            <div class="flex gap-2">
                <button id="exportBtn" class="text-[10px] bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded-full border border-emerald-100 font-bold">å‚™ä»½</button>
                <button id="toggleAddForm" class="text-[10px] bg-blue-50 text-blue-600 px-3 py-1.5 rounded-full border border-blue-100 font-bold">+ æ–°å¢</button>
            </div>
        </div>

        <!-- ç¾¤çµ„é¸æ“‡ -->
        <div class="mb-4 bg-blue-600 p-3 rounded-xl shadow-lg">
            <select id="groupFilter" class="bg-white text-blue-700 text-sm font-bold rounded-lg block w-full p-2 outline-none border-none shadow-inner">
                <option value="ALL">å…¨éƒ¨å–®å­—</option>
            </select>
        </div>

        <!-- æ‰‹å‹•æ–°å¢è¡¨å–® -->
        <div id="addForm" class="hidden bg-slate-50 p-4 rounded-xl mb-4 border border-blue-200 shadow-inner">
            <div class="grid grid-cols-2 gap-2 mb-2">
                <input type="text" id="newWord" placeholder="å–®å­—" class="p-2 border rounded-lg text-sm outline-blue-400">
                <input type="text" id="newGroup" placeholder="ç¾¤çµ„ (é¸å¡«)" class="p-2 border rounded-lg text-sm outline-blue-400">
            </div>
            <input type="text" id="newPos" placeholder="è©æ€§" class="w-full p-2 border rounded-lg mb-2 text-sm outline-blue-400">
            <textarea id="newDef" placeholder="å®šç¾© (æ”¯æ´æ›è¡Œ)" class="w-full p-2 border rounded-lg mb-2 text-sm outline-blue-400" rows="3"></textarea>
            <textarea id="newEx" placeholder="ä¾‹å¥" class="w-full p-2 border rounded-lg mb-2 text-sm outline-blue-400" rows="2"></textarea>
            <div class="flex gap-2">
                <button id="saveWordBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg flex-1 font-bold shadow-md">å„²å­˜å–®å­—</button>
                <button id="closeFormBtn" class="bg-slate-300 text-slate-700 px-4 py-2 rounded-lg font-bold">å–æ¶ˆ</button>
            </div>
        </div>
        
        <!-- æ’­æ”¾èˆ‡è¨­å®š -->
        <div class="space-y-3">
            <input type="file" id="excelInput" accept=".xlsx, .xls" class="block w-full text-[10px] text-slate-400 file:mr-3 file:py-1.5 file:px-4 file:rounded-full file:border-0 file:bg-slate-200 file:text-slate-600 cursor-pointer"/>

            <div class="flex flex-wrap gap-4 items-center justify-between px-1">
                <div class="flex items-center gap-3">
                    <label class="text-[11px] font-black text-slate-400 uppercase">èªé€Ÿ <span id="speedVal" class="text-blue-500 font-bold">1.0</span></label>
                    <input type="range" id="speedRange" min="0.5" max="2" step="0.1" value="1.0" class="w-20 h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                </div>
                <div class="flex gap-4">
                    <label class="flex items-center gap-1.5 cursor-pointer text-[11px] font-black text-slate-500"><input type="checkbox" id="sayExample" checked> å¿µä¾‹å¥</label>
                    <label class="flex items-center gap-1.5 cursor-pointer text-[11px] font-black text-slate-500"><input type="checkbox" id="autoScroll" checked> æ²å‹•</label>
                </div>
            </div>

            <div class="flex gap-2">
                <button id="playBtn" class="flex-[3] bg-blue-600 text-white py-4 rounded-xl font-black text-lg shadow-xl shadow-blue-200 active:scale-95 transition-all">é–‹å§‹å¾ªç’°æ’­æ”¾</button>
                <button id="stopBtn" class="flex-1 bg-slate-200 text-slate-600 py-4 rounded-xl font-black active:scale-95 transition-all">åœæ­¢</button>
                <button id="clearBtn" class="bg-red-50 text-red-400 px-3 rounded-xl text-[10px] font-bold border border-red-50">æ¸…ç©º</button>
            </div>
        </div>
    </header>

    <!-- å–®å­—åˆ—è¡¨ -->
    <div id="wordList" class="space-y-3 mt-4"></div>
</div>

<!-- æ”¹ç‰ˆæ­·å² Modal -->
<div id="historyModal" class="fixed inset-0 bg-black/60 z-[50] flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl">
        <h2 class="text-xl font-black text-slate-800 mb-4 border-b pb-2">æ”¹ç‰ˆæ­·å²ç´€éŒ„</h2>
        <div class="space-y-4 max-h-[60vh] overflow-y-auto text-sm leading-relaxed pr-2">
            <div>
                <span class="font-bold text-blue-600">v1.1.0 (ç•¶å‰ç‰ˆæœ¬)</span>
                <p class="text-slate-600">ãƒ»åŠ å…¥æ”¹ç‰ˆæ­·å²æŸ¥çœ‹åŠŸèƒ½ã€‚<br>ãƒ»ä»£ç¢¼é‡æ§‹ï¼ŒåŠ å…¥æŠ€è¡“äº¤æ¥è¨»è§£ã€‚<br>ãƒ»å„ªåŒ–å­˜æª”åŒæ­¥èˆ‡ç•«é¢åˆ·æ–°é‚è¼¯ã€‚</p>
            </div>
            <div>
                <span class="font-bold text-slate-700">v1.0.5</span>
                <p class="text-slate-500">ãƒ»æ–°å¢å–®å­—ç·¨è™Ÿ (#) é¡¯ç¤ºã€‚<br>ãƒ»åŠ å…¥ Group ç¾¤çµ„åˆ†é¡åŠŸèƒ½ã€‚<br>ãƒ»æ”¯æ´ Excel æ›è¡Œæ ¼å¼ä¿ç•™ (white-space)ã€‚</p>
            </div>
            <div>
                <span class="font-bold text-slate-700">v1.0.0</span>
                <p class="text-slate-500">ãƒ»æ ¸å¿ƒåŠŸèƒ½ä¸Šç·šï¼šExcel åŒ¯å…¥ã€TTS ç™¼éŸ³ã€IndexedDB æ°¸ä¹…å„²å­˜ã€‚</p>
            </div>
        </div>
        <button id="closeHistory" class="mt-6 w-full bg-slate-800 text-white py-3 rounded-xl font-bold">é—œé–‰</button>
    </div>
</div>

<script>
    /* -------------------------------------------------------------------------
       1. è³‡æ–™åº«åˆå§‹åŒ– (DATA PERSISTENCE)
    ------------------------------------------------------------------------- */
    const db = new Dexie("VocabProDB_Stable");
    db.version(1).stores({ 
        words: "++id, &Word, Group, Pos, Definition, Example" 
    });

    let allWords = [];
    let filteredWords = [];
    let currentIndex = -1;
    let isPlaying = false;
    const synth = window.speechSynthesis;

    window.onload = async () => {
        // å¾ LocalStorage æ¢å¾©ç”¨æˆ¶è¨­å®š
        const speed = localStorage.getItem('pro_speed') || '1.0';
        document.getElementById('speedRange').value = speed;
        document.getElementById('speedVal').innerText = speed;
        document.getElementById('sayExample').checked = localStorage.getItem('pro_sayEx') !== 'false';
        document.getElementById('autoScroll').checked = localStorage.getItem('pro_scroll') !== 'false';
        
        await loadData();
    };

    /* -------------------------------------------------------------------------
       2. è³‡æ–™è™•ç†é‚è¼¯ (DATA LOGIC)
    ------------------------------------------------------------------------- */
    async function loadData() {
        allWords = await db.words.toArray();
        const groups = [...new Set(allWords.map(w => w.Group || 'æœªåˆ†é¡'))];
        const groupFilter = document.getElementById('groupFilter');
        const lastGroup = localStorage.getItem('pro_lastGroup') || 'ALL';
        
        groupFilter.innerHTML = `<option value="ALL">å…¨éƒ¨å–®å­— (${allWords.length})</option>` + 
            groups.map(g => `<option value="${g}">${g}</option>`).join('');
        
        if ([...groupFilter.options].some(opt => opt.value === lastGroup)) groupFilter.value = lastGroup;
        filterWords();
    }

    function filterWords() {
        const selectedGroup = document.getElementById('groupFilter').value;
        localStorage.setItem('pro_lastGroup', selectedGroup);
        filteredWords = (selectedGroup === 'ALL') ? allWords : allWords.filter(w => (w.Group || 'æœªåˆ†é¡') === selectedGroup);
        document.getElementById('totalCount').innerText = `ç›®å‰ç¾¤çµ„: ${filteredWords.length} / ç¸½é‡: ${allWords.length}`;
        renderList();
    }

    function renderList() {
        const wordListEl = document.getElementById('wordList');
        if (filteredWords.length === 0) {
            wordListEl.innerHTML = `<div class="text-center py-20 text-slate-300 italic text-sm">è«‹åŒ¯å…¥ Excel é–‹å§‹å­¸ç¿’</div>`;
            return;
        }
        wordListEl.innerHTML = filteredWords.map((item, index) => `
            <div id="word-${index}" class="word-card p-5 bg-white rounded-2xl shadow-sm border border-slate-100 flex gap-4" onclick="preview(${index})">
                <div class="text-blue-200 font-black text-[10px] pt-1">#${index + 1}</div>
                <div class="flex-1">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xl font-bold text-slate-800">${item.Word}</span>
                        <span class="text-[9px] font-black text-blue-500 bg-blue-50 px-2 py-0.5 rounded uppercase tracking-tighter">${item.Pos || ''}</span>
                    </div>
                    <div class="text-slate-600 text-sm leading-relaxed preserve-format font-medium">${item.Definition || ''}</div>
                    ${item.Example ? `<div class="mt-3 p-2.5 bg-slate-50 rounded-lg text-slate-500 text-xs italic preserve-format border-l-2 border-slate-200">${item.Example}</div>` : ''}
                </div>
            </div>
        `).join('');
    }

    /* -------------------------------------------------------------------------
       3. ç™¼éŸ³æ§åˆ¶é‚è¼¯ (AUDIO LOGIC)
    ------------------------------------------------------------------------- */
    function speak(text, callback) {
        if (!isPlaying && !window.single) return;
        const utter = new SpeechSynthesisUtterance(text);
        utter.rate = parseFloat(document.getElementById('speedRange').value);
        utter.lang = 'en-US';
        utter.onend = callback;
        
        // MediaSession Metadata: ä½¿é–å±æ™‚é¡¯ç¤ºç›®å‰æœ—è®€å–®å­—
        if ('mediaSession' in navigator && isPlaying) {
            navigator.mediaSession.metadata = new MediaMetadata({
                title: filteredWords[currentIndex].Word,
                artist: 'Vocab Pro æ­£åœ¨å­¸ç¿’ä¸­...',
                album: 'English Master'
            });
        }
        synth.speak(utter);
    }

    async function playLoop() {
        if (!isPlaying) return;
        if (currentIndex >= filteredWords.length - 1) currentIndex = -1;
        currentIndex++;
        
        document.querySelectorAll('.active-word').forEach(el => el.classList.remove('active-word'));
        const currentEl = document.getElementById(`word-${currentIndex}`);
        if (currentEl) {
            currentEl.classList.add('active-word');
            if (document.getElementById('autoScroll').checked) currentEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        const wordObj = filteredWords[currentIndex];
        speak(wordObj.Word, () => {
            if (document.getElementById('sayExample').checked && wordObj.Example) {
                setTimeout(() => speak(wordObj.Example, () => setTimeout(playLoop, 2000)), 800);
            } else {
                setTimeout(playLoop, 1500);
            }
        });
    }

    /* -------------------------------------------------------------------------
       4. äº‹ä»¶ç›£è½èˆ‡äº¤äº’ (UI & EVENT LISTENERS)
    ------------------------------------------------------------------------- */
    // ç‰ˆæœ¬èˆ‡æ­·å² Modal
    document.getElementById('versionTag').addEventListener('click', () => document.getElementById('historyModal').style.display = 'flex');
    document.getElementById('closeHistory').addEventListener('click', () => document.getElementById('historyModal').style.display = 'none');

    // å„²å­˜å–®å­—
    document.getElementById('saveWordBtn').addEventListener('click', async () => {
        const Word = document.getElementById('newWord').value.trim();
        if (!Word) return;
        await db.words.put({
            Word,
            Group: document.getElementById('newGroup').value.trim() || 'æœªåˆ†é¡',
            Pos: document.getElementById('newPos').value.trim(),
            Definition: document.getElementById('newDef').value.trim(),
            Example: document.getElementById('newEx').value.trim()
        });
        document.getElementById('addForm').classList.add('hidden');
        await loadData();
    });

    // æ’­æ”¾èˆ‡åœæ­¢
    document.getElementById('playBtn').addEventListener('click', () => {
        if (filteredWords.length === 0) return;
        isPlaying = true;
        document.getElementById('playBtn').innerText = "ğŸ”Š æ’­æ”¾ä¸­...";
        playLoop();
    });

    document.getElementById('stopBtn').addEventListener('click', () => {
        isPlaying = false;
        synth.cancel();
        document.getElementById('playBtn').innerText = "é–‹å§‹å¾ªç’°æ’­æ”¾";
    });

    // Excel åŒ¯å…¥
    document.getElementById('excelInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data);
        const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
        for (const item of jsonData) {
            try {
                await db.words.put({
                    Word: String(item.Word || '').trim(),
                    Group: String(item.Group || 'æœªåˆ†é¡').trim(),
                    Pos: String(item.Pos || '').trim(),
                    Definition: String(item.Definition || '').trim(),
                    Example: String(item.Example || '').trim()
                });
            } catch (e) {}
        }
        await loadData();
        e.target.value = "";
    });

    // å°å‡ºå‚™ä»½
    document.getElementById('exportBtn').addEventListener('click', async () => {
        const all = await db.words.toArray();
        const ws = XLSX.utils.json_to_sheet(all.map(w => ({Word:w.Word, Group:w.Group, Pos:w.Pos, Definition:w.Definition, Example:w.Example})));
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Backup");
        XLSX.writeFile(wb, `Vocab_Backup_${new Date().toLocaleDateString()}.xlsx`);
    });

    // è¨­å®šåŒæ­¥åˆ° LocalStorage
    document.getElementById('groupFilter').addEventListener('change', () => { isPlaying = false; synth.cancel(); filterWords(); });
    document.getElementById('speedRange').addEventListener('change', (e) => {
        localStorage.setItem('pro_speed', e.target.value);
        document.getElementById('speedVal').innerText = e.target.value;
    });
    document.getElementById('sayExample').addEventListener('change', (e) => localStorage.setItem('pro_sayEx', e.target.checked));
    document.getElementById('autoScroll').addEventListener('change', (e) => localStorage.setItem('pro_scroll', e.target.checked));

    // UI åˆ‡æ›
    document.getElementById('toggleAddForm').addEventListener('click', () => document.getElementById('addForm').classList.toggle('hidden'));
    document.getElementById('closeFormBtn').addEventListener('click', () => document.getElementById('addForm').classList.add('hidden'));
    document.getElementById('clearBtn').addEventListener('click', async () => { if(confirm('ç¢ºå®šè¦æ°¸ä¹…æ¸…ç©ºè³‡æ–™å—ï¼Ÿ')){ await db.words.clear(); loadData(); } });

    // é è¦½å–®ä¸€ç™¼éŸ³
    window.preview = (index) => {
        window.single = true;
        const utter = new SpeechSynthesisUtterance(filteredWords[index].Word);
        utter.lang = 'en-US';
        utter.onend = () => window.single = false;
        synth.speak(utter);
    };
</script>
</body>
</html>