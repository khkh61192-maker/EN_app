<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocab Pro - 永久儲存穩定版</title>
    <script src="https://cdn.jsdelivr.net/npm/dexie@3/dist/dexie.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .preserve-format { white-space: pre-wrap; word-break: break-word; }
        .active-word { background-color: #fef3c7; border-left: 6px solid #f59e0b; transform: scale(1.02); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .word-card { transition: all 0.2s ease-out; }
        html { scroll-behavior: smooth; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen pb-20 font-sans text-slate-800">

<div class="max-w-2xl mx-auto p-4">
    <!-- 頂部控制面板 -->
    <header class="sticky top-0 bg-white/95 backdrop-blur shadow-md p-4 rounded-b-2xl z-30 mb-2">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h1 class="text-xl font-black text-blue-600">Vocab Pro</h1>
                <p id="totalCount" class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-1">正在連接資料庫...</p>
            </div>
            <div class="flex gap-2">
                <button id="exportBtn" class="text-[10px] bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded-full border border-emerald-100 font-bold">備份</button>
                <button id="toggleAddForm" class="text-[10px] bg-blue-50 text-blue-600 px-3 py-1.5 rounded-full border border-blue-100 font-bold">+ 新增</button>
            </div>
        </div>

        <!-- 群組選擇器 -->
        <div class="mb-4 bg-blue-600 p-3 rounded-xl shadow-lg flex items-center gap-3">
            <span class="text-white text-xs font-bold whitespace-nowrap italic">GO:</span>
            <select id="groupFilter" class="bg-white text-blue-700 text-sm font-bold rounded-lg block w-full p-2 outline-none shadow-sm">
                <option value="ALL">全部單字</option>
            </select>
        </div>

        <!-- 手動新增 (預設隱藏) -->
        <div id="addForm" class="hidden bg-slate-50 p-4 rounded-xl mb-4 border border-slate-200 shadow-inner">
            <div class="grid grid-cols-2 gap-2 mb-2">
                <input type="text" id="newWord" placeholder="單字" class="p-2 border rounded-lg text-sm">
                <input type="text" id="newGroup" placeholder="群組" class="p-2 border rounded-lg text-sm">
            </div>
            <textarea id="newDef" placeholder="定義" class="w-full p-2 border rounded-lg mb-2 text-sm" rows="3"></textarea>
            <textarea id="newEx" placeholder="例句" class="w-full p-2 border rounded-lg mb-2 text-sm" rows="2"></textarea>
            <div class="flex gap-2">
                <button id="saveWordBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg flex-1 font-bold">儲存到資料庫</button>
                <button id="closeFormBtn" class="bg-slate-300 text-slate-700 px-4 py-2 rounded-lg">取消</button>
            </div>
        </div>
        
        <div class="space-y-3">
            <input type="file" id="excelInput" accept=".xlsx, .xls" class="block w-full text-[10px] text-slate-400 file:mr-3 file:py-1 file:px-3 file:rounded-full file:border-0 file:bg-slate-200 file:text-slate-600 cursor-pointer"/>

            <div class="flex flex-wrap gap-4 items-center justify-between px-1">
                <div class="flex items-center gap-3">
                    <label class="text-xs font-bold text-slate-500">語速: <span id="speedVal" class="text-blue-600">1.0</span></label>
                    <input type="range" id="speedRange" min="0.5" max="2" step="0.1" value="1.0" class="w-20 h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                </div>
                <div class="flex gap-3">
                    <label class="flex items-center gap-1.5 cursor-pointer text-xs font-bold text-slate-500"><input type="checkbox" id="sayExample" checked> 念例句</label>
                    <label class="flex items-center gap-1.5 cursor-pointer text-xs font-bold text-slate-500"><input type="checkbox" id="autoScroll" checked> 捲動</label>
                </div>
            </div>

            <div class="flex gap-2">
                <button id="playBtn" class="flex-[3] bg-blue-600 text-white py-3 rounded-xl font-black text-lg shadow-lg active:scale-95 transition-all">播放目前群組</button>
                <button id="stopBtn" class="flex-1 bg-slate-200 text-slate-600 py-3 rounded-xl font-bold">停止</button>
                <button id="clearBtn" class="bg-red-50 text-red-400 px-3 rounded-xl text-xs font-bold">重設</button>
            </div>
        </div>
    </header>

    <div id="wordList" class="space-y-3 mt-4"></div>
</div>

<script>
    // --- 1. 資料庫設定：固定名稱，確保永久儲存 ---
    const db = new Dexie("VocabMasterStorage"); // 固定資料庫名稱
    db.version(1).stores({ 
        words: "++id, &Word, Group, Pos, Definition, Example" 
    });

    let allWords = [];
    let filteredWords = [];
    let currentIndex = -1;
    let isPlaying = false;
    const synth = window.speechSynthesis;

    // --- 2. 啟動時自動載入 ---
    window.addEventListener('DOMContentLoaded', async () => {
        // 從 LocalStorage 恢復設定
        if (localStorage.getItem('vocab_speed')) {
            const speed = localStorage.getItem('vocab_speed');
            document.getElementById('speedRange').value = speed;
            document.getElementById('speedVal').innerText = speed;
        }
        document.getElementById('sayExample').checked = localStorage.getItem('vocab_sayEx') !== 'false';
        document.getElementById('autoScroll').checked = localStorage.getItem('vocab_scroll') !== 'false';

        await loadData(); // 載入資料庫單字
    });

    async function loadData() {
        allWords = await db.words.toArray();
        
        // 更新群組清單
        const groups = [...new Set(allWords.map(w => w.Group || '未分類'))];
        const groupFilter = document.getElementById('groupFilter');
        
        // 記住上次選的群組
        const lastGroup = localStorage.getItem('vocab_lastGroup') || 'ALL';
        
        groupFilter.innerHTML = `<option value="ALL">全部單字 (${allWords.length})</option>` + 
            groups.map(g => `<option value="${g}">${g} (${allWords.filter(w => (w.Group || '未分類') === g).length})</option>`).join('');
        
        // 如果上次選的群組還在，就選它
        if ([...groupFilter.options].some(opt => opt.value === lastGroup)) {
            groupFilter.value = lastGroup;
        }

        filterWords();
    }

    function filterWords() {
        const selectedGroup = document.getElementById('groupFilter').value;
        localStorage.setItem('vocab_lastGroup', selectedGroup); // 記憶群組選擇

        if (selectedGroup === 'ALL') {
            filteredWords = allWords;
        } else {
            filteredWords = allWords.filter(w => (w.Group || '未分類') === selectedGroup);
        }
        
        document.getElementById('totalCount').innerText = `目前群組: ${filteredWords.length} / 總量: ${allWords.length}`;
        renderList();
    }

    // --- 3. 渲染介面 ---
    function renderList() {
        const wordListEl = document.getElementById('wordList');
        if (filteredWords.length === 0) {
            wordListEl.innerHTML = `<div class="text-center py-20 text-slate-300 italic">資料庫目前沒有單字，請匯入 Excel</div>`;
            return;
        }

        wordListEl.innerHTML = filteredWords.map((item, index) => `
            <div id="word-${index}" class="word-card p-5 bg-white rounded-2xl shadow-sm border border-slate-100 flex gap-4" onclick="previewSpeak(${index})">
                <div class="text-blue-300 font-black text-[10px] pt-1 w-6">#${index + 1}</div>
                <div class="flex-1">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xl font-bold text-slate-800">${item.Word}</span>
                        <span class="text-[9px] font-black text-blue-500 bg-blue-50 px-2 py-0.5 rounded uppercase">${item.Pos || ''}</span>
                    </div>
                    <div class="text-slate-600 text-sm leading-relaxed preserve-format font-medium">${item.Definition || ''}</div>
                    ${item.Example ? `<div class="mt-3 p-2 bg-slate-50 rounded-lg text-slate-500 text-xs italic preserve-format border-l-2 border-slate-200">${item.Example}</div>` : ''}
                </div>
            </div>
        `).join('');
    }

    // --- 4. 播放控制 ---
    function speak(text, callback) {
        if (!isPlaying && !window.singlePlay) return;
        const utter = new SpeechSynthesisUtterance(text);
        utter.rate = parseFloat(document.getElementById('speedRange').value);
        utter.lang = 'en-US';
        utter.onend = callback;
        synth.speak(utter);
    }

    window.previewSpeak = (index) => {
        window.singlePlay = true;
        synth.cancel();
        speak(filteredWords[index].Word, () => { window.singlePlay = false; });
    };

    async function playLoop() {
        if (!isPlaying) return;
        if (currentIndex >= filteredWords.length - 1) currentIndex = -1;
        currentIndex++;
        
        document.querySelectorAll('.active-word').forEach(el => el.classList.remove('active-word'));
        const currentEl = document.getElementById(`word-${currentIndex}`);
        if (currentEl) {
            currentEl.classList.add('active-word');
            if (document.getElementById('autoScroll').checked) currentEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        const wordObj = filteredWords[currentIndex];
        speak(wordObj.Word, () => {
            const waitTime = document.getElementById('sayExample').checked && wordObj.Example ? 2000 : 1500;
            if (document.getElementById('sayExample').checked && wordObj.Example) {
                setTimeout(() => speak(wordObj.Example, () => setTimeout(playLoop, waitTime)), 800);
            } else {
                setTimeout(playLoop, waitTime);
            }
        });
    }

    // --- 5. 事件監聽 (含設定儲存) ---
    document.getElementById('groupFilter').addEventListener('change', () => {
        currentIndex = -1; isPlaying = false; synth.cancel();
        document.getElementById('playBtn').innerText = "播放目前群組";
        filterWords();
    });

    document.getElementById('speedRange').addEventListener('change', (e) => {
        localStorage.setItem('vocab_speed', e.target.value);
        document.getElementById('speedVal').innerText = e.target.value;
    });

    document.getElementById('sayExample').addEventListener('change', (e) => localStorage.setItem('vocab_sayEx', e.target.checked));
    document.getElementById('autoScroll').addEventListener('change', (e) => localStorage.setItem('vocab_scroll', e.target.checked));

    document.getElementById('saveWordBtn').addEventListener('click', async () => {
        const Word = document.getElementById('newWord').value.trim();
        if (!Word) return;
        await db.words.add({ 
            Word, 
            Group: document.getElementById('newGroup').value.trim() || '未分類', 
            Pos: document.getElementById('newPos').value.trim(), 
            Definition: document.getElementById('newDef').value.trim(), 
            Example: document.getElementById('newEx').value.trim() 
        });
        document.getElementById('addForm').classList.add('hidden');
        loadData();
    });

    document.getElementById('playBtn').addEventListener('click', () => {
        if (filteredWords.length === 0) return;
        isPlaying = true;
        document.getElementById('playBtn').innerText = "正在播放中...";
        playLoop();
    });

    document.getElementById('stopBtn').addEventListener('click', () => {
        isPlaying = false; synth.cancel();
        document.getElementById('playBtn').innerText = "繼續播放";
    });

    document.getElementById('excelInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data);
        const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
        for (const item of jsonData) {
            try { await db.words.add({
                Word: String(item.Word || '').trim(),
                Group: String(item.Group || '未分類').trim(),
                Pos: String(item.Pos || '').trim(),
                Definition: String(item.Definition || '').trim(),
                Example: String(item.Example || '').trim()
            }); } catch (e) {}
        }
        loadData();
        e.target.value = "";
    });

    document.getElementById('exportBtn').addEventListener('click', async () => {
        const all = await db.words.toArray();
        const ws = XLSX.utils.json_to_sheet(all.map(w => ({Word:w.Word, Group:w.Group, Pos:w.Pos, Definition:w.Definition, Example:w.Example})));
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Words");
        XLSX.writeFile(wb, `MyVocabBackup.xlsx`);
    });

    document.getElementById('toggleAddForm').addEventListener('click', () => document.getElementById('addForm').classList.toggle('hidden'));
    document.getElementById('closeFormBtn').addEventListener('click', () => document.getElementById('addForm').classList.add('hidden'));
    document.getElementById('clearBtn').addEventListener('click', async () => { if(confirm('確定要永久刪除所有單字嗎？刪除前建議先備份。')){ await db.words.clear(); loadData(); } });

</script>
</body>
</html>