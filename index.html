<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vocab Pro - èƒŒæ™¯æ’­æ”¾èˆ‡ä¿®å¾©ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/dexie@3/dist/dexie.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .preserve-format { white-space: pre-wrap; word-break: break-word; }
        .active-word { background-color: #fef3c7; border-left: 6px solid #f59e0b; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .word-card { transition: all 0.2s ease-out; }
        html { scroll-behavior: smooth; }
        /* é¿å… iOS æ”¾å¤§ input */
        input, textarea, select { font-size: 16px !important; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen pb-24 font-sans text-slate-800">

<!-- éš±å½¢éŸ³é »ï¼Œç”¨ä¾†é¨™éç³»çµ±ç¶­æŒèƒŒæ™¯é‹ä½œ -->
<audio id="silentAudio" loop><source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAgD5AAAB+AAABAAgAZGF0YQAAAAA=" type="audio/wav"></audio>

<div class="max-w-2xl mx-auto p-4">
    <header class="sticky top-0 bg-white/95 backdrop-blur shadow-md p-4 rounded-b-2xl z-30 mb-2">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h1 class="text-xl font-black text-blue-600">Vocab Pro</h1>
                <p id="totalCount" class="text-[10px] text-slate-400 font-bold tracking-widest mt-1 uppercase">Loading Storage...</p>
            </div>
            <div class="flex gap-2">
                <button id="exportBtn" class="text-[10px] bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded-full border border-emerald-100 font-bold shadow-sm">å‚™ä»½</button>
                <button id="toggleAddForm" class="text-[10px] bg-blue-50 text-blue-600 px-3 py-1.5 rounded-full border border-blue-100 font-bold shadow-sm">+ æ–°å¢</button>
            </div>
        </div>

        <div class="mb-4 bg-blue-600 p-3 rounded-xl shadow-lg flex items-center gap-2">
            <span class="text-white text-[10px] font-black italic">LEARN:</span>
            <select id="groupFilter" class="bg-white text-blue-700 text-sm font-bold rounded-lg block w-full p-2 outline-none border-none shadow-sm cursor-pointer">
                <option value="ALL">æ‰€æœ‰å–®å­—</option>
            </select>
        </div>

        <!-- æ‰‹å‹•æ–°å¢è¡¨å–® -->
        <div id="addForm" class="hidden bg-slate-50 p-4 rounded-xl mb-4 border border-blue-200 shadow-inner">
            <div class="grid grid-cols-2 gap-2 mb-2">
                <input type="text" id="newWord" placeholder="å–®å­— (å¿…å¡«)" class="p-2 border rounded-lg text-sm bg-white outline-blue-400">
                <input type="text" id="newGroup" placeholder="ç¾¤çµ„åç¨±" class="p-2 border rounded-lg text-sm bg-white outline-blue-400">
            </div>
            <input type="text" id="newPos" placeholder="è©æ€§" class="w-full p-2 border rounded-lg mb-2 text-sm bg-white outline-blue-400">
            <textarea id="newDef" placeholder="å®šç¾©å…§å®¹ (æ”¯æ´æ›è¡Œ)" class="w-full p-2 border rounded-lg mb-2 text-sm bg-white outline-blue-400" rows="3"></textarea>
            <textarea id="newEx" placeholder="ä¾‹å¥å…§å®¹" class="w-full p-2 border rounded-lg mb-2 text-sm bg-white outline-blue-400" rows="2"></textarea>
            <div class="flex gap-2">
                <button id="saveWordBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg flex-1 font-bold shadow-md hover:bg-blue-700">ç«‹å³å„²å­˜</button>
                <button id="closeFormBtn" class="bg-slate-300 text-slate-700 px-4 py-2 rounded-lg font-bold">å–æ¶ˆ</button>
            </div>
        </div>
        
        <div class="space-y-3">
            <input type="file" id="excelInput" accept=".xlsx, .xls" class="block w-full text-[10px] text-slate-400 file:mr-3 file:py-1.5 file:px-4 file:rounded-full file:border-0 file:bg-slate-200 file:text-slate-600 cursor-pointer"/>

            <div class="flex flex-wrap gap-4 items-center justify-between px-1">
                <div class="flex items-center gap-3">
                    <label class="text-[11px] font-black text-slate-400">èªé€Ÿ <span id="speedVal" class="text-blue-500">1.0</span></label>
                    <input type="range" id="speedRange" min="0.5" max="2" step="0.1" value="1.0" class="w-24 h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                </div>
                <div class="flex gap-4">
                    <label class="flex items-center gap-1.5 cursor-pointer text-[11px] font-black text-slate-500"><input type="checkbox" id="sayExample" checked> å¿µä¾‹å¥</label>
                    <label class="flex items-center gap-1.5 cursor-pointer text-[11px] font-black text-slate-500"><input type="checkbox" id="autoScroll" checked> æ²å‹•</label>
                </div>
            </div>

            <div class="flex gap-2">
                <button id="playBtn" class="flex-[3] bg-blue-600 text-white py-4 rounded-xl font-black text-lg shadow-xl shadow-blue-200 active:scale-95 transition-all">é–‹å§‹å¾ªç’°æ’­æ”¾</button>
                <button id="stopBtn" class="flex-1 bg-slate-200 text-slate-600 py-4 rounded-xl font-black active:scale-95 transition-all">åœæ­¢</button>
                <button id="clearBtn" class="bg-red-50 text-red-400 px-3 rounded-xl text-[10px] font-bold border border-red-50">é‡è¨­</button>
            </div>
        </div>
    </header>

    <div id="wordList" class="space-y-3 mt-4 px-1"></div>
</div>

<script>
    // --- 1. è³‡æ–™åº«é‚è¼¯ (ä½¿ç”¨ç©©å®šç‰ˆ Dexie) ---
    const db = new Dexie("VocabMasterStorageV6");
    db.version(1).stores({ 
        words: "++id, &Word, Group, Pos, Definition, Example" 
    });

    let allWords = [];
    let filteredWords = [];
    let currentIndex = -1;
    let isPlaying = false;
    const synth = window.speechSynthesis;
    const silentAudio = document.getElementById('silentAudio');

    // --- 2. å•Ÿå‹•èˆ‡è¼‰å…¥ ---
    window.onload = async () => {
        // æ¢å¾©ä½¿ç”¨è€…è¨­å®š
        const speed = localStorage.getItem('v6_speed') || '1.0';
        document.getElementById('speedRange').value = speed;
        document.getElementById('speedVal').innerText = speed;
        document.getElementById('sayExample').checked = localStorage.getItem('v6_sayEx') !== 'false';
        document.getElementById('autoScroll').checked = localStorage.getItem('v6_scroll') !== 'false';
        
        await loadData();
    };

    async function loadData() {
        allWords = await db.words.toArray();
        const groups = [...new Set(allWords.map(w => w.Group || 'æœªåˆ†é¡'))];
        const groupFilter = document.getElementById('groupFilter');
        const lastGroup = localStorage.getItem('v6_lastGroup') || 'ALL';
        
        groupFilter.innerHTML = `<option value="ALL">æ‰€æœ‰å–®å­— (${allWords.length})</option>` + 
            groups.map(g => `<option value="${g}">${g} (${allWords.filter(w => (w.Group || 'æœªåˆ†é¡') === g).length})</option>`).join('');
        
        if ([...groupFilter.options].some(opt => opt.value === lastGroup)) groupFilter.value = lastGroup;
        filterWords();
    }

    function filterWords() {
        const selectedGroup = document.getElementById('groupFilter').value;
        localStorage.setItem('v6_lastGroup', selectedGroup);
        filteredWords = (selectedGroup === 'ALL') ? allWords : allWords.filter(w => (w.Group || 'æœªåˆ†é¡') === selectedGroup);
        document.getElementById('totalCount').innerText = `GROUP: ${filteredWords.length} / TOTAL: ${allWords.length}`;
        renderList();
    }

    function renderList() {
        const wordListEl = document.getElementById('wordList');
        if (filteredWords.length === 0) {
            wordListEl.innerHTML = `<div class="text-center py-20 text-slate-300 italic text-sm">è«‹åŒ¯å…¥ Excel æˆ–é»æ“Šå³ä¸Šæ–¹ã€Œ+æ–°å¢ã€å–®å­—</div>`;
            return;
        }
        wordListEl.innerHTML = filteredWords.map((item, index) => `
            <div id="word-${index}" class="word-card p-5 bg-white rounded-2xl shadow-sm border border-slate-100 flex gap-4" onclick="previewSpeak(${index})">
                <div class="text-blue-300 font-black text-[10px] pt-1">#${index + 1}</div>
                <div class="flex-1">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xl font-bold text-slate-800">${item.Word}</span>
                        <span class="text-[9px] font-black text-blue-500 bg-blue-50 px-2 py-0.5 rounded uppercase tracking-tighter">${item.Pos || ''}</span>
                    </div>
                    <div class="text-slate-600 text-sm leading-relaxed preserve-format font-medium">${item.Definition || ''}</div>
                    ${item.Example ? `<div class="mt-3 p-2.5 bg-slate-50 rounded-lg text-slate-500 text-xs italic preserve-format border-l-2 border-slate-200">${item.Example}</div>` : ''}
                </div>
            </div>
        `).join('');
    }

    // --- 3. ç™¼éŸ³èˆ‡èƒŒæ™¯æ’­æ”¾æ ¸å¿ƒ ---
    function speak(text, callback) {
        if (!isPlaying && !window.singlePlay) return;
        
        const utter = new SpeechSynthesisUtterance(text);
        utter.rate = parseFloat(document.getElementById('speedRange').value);
        utter.lang = 'en-US';
        utter.onend = callback;
        
        // æ ¸å¿ƒï¼šå•Ÿç”¨åª’é«”æœƒè©± Metadataï¼Œé€™æ˜¯èƒŒæ™¯æ’­æ”¾æˆåŠŸçš„é—œéµ
        if ('mediaSession' in navigator && isPlaying) {
            navigator.mediaSession.metadata = new MediaMetadata({
                title: filteredWords[currentIndex].Word,
                artist: 'Vocab Pro æ­£åœ¨æœ—è®€...',
                album: 'English Learning'
            });
        }
        
        synth.speak(utter);
    }

    window.previewSpeak = (index) => {
        window.singlePlay = true;
        synth.cancel();
        speak(filteredWords[index].Word, () => window.singlePlay = false);
    };

    async function playLoop() {
        if (!isPlaying) return;
        if (currentIndex >= filteredWords.length - 1) currentIndex = -1;
        currentIndex++;
        
        // UI æ›´æ–°
        document.querySelectorAll('.active-word').forEach(el => el.classList.remove('active-word'));
        const currentEl = document.getElementById(`word-${currentIndex}`);
        if (currentEl) {
            currentEl.classList.add('active-word');
            if (document.getElementById('autoScroll').checked) currentEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        const wordObj = filteredWords[currentIndex];
        
        // æœ—è®€å–®å­—
        speak(wordObj.Word, () => {
            const hasEx = document.getElementById('sayExample').checked && wordObj.Example;
            if (hasEx) {
                setTimeout(() => speak(wordObj.Example, () => setTimeout(playLoop, 2000)), 800);
            } else {
                setTimeout(playLoop, 1500);
            }
        });
    }

    // --- 4. å­˜æª”èˆ‡äº’å‹•é‚è¼¯ ---
    document.getElementById('saveWordBtn').addEventListener('click', async () => {
        const Word = document.getElementById('newWord').value.trim();
        const Group = document.getElementById('newGroup').value.trim() || 'æœªåˆ†é¡';
        const Pos = document.getElementById('newPos').value.trim();
        const Definition = document.getElementById('newDef').value.trim();
        const Example = document.getElementById('newEx').value.trim();

        if (!Word) { alert("å–®å­—åç¨±ä¸èƒ½ç‚ºç©ºï¼"); return; }

        try {
            // ä½¿ç”¨ put å–ä»£ addï¼Œå³ä½¿å–®å­—é‡è¤‡ä¹Ÿæœƒæ›´æ–°å…§å®¹è€Œä¸æœƒå‡ºéŒ¯
            await db.words.put({ Word, Group, Pos, Definition, Example });
            
            // æ¸…ç©ºè¡¨å–®ä¸¦éš±è—
            document.querySelectorAll('#addForm input, #addForm textarea').forEach(i => i.value = '');
            document.getElementById('addForm').classList.add('hidden');
            
            // ç«‹å³é‡æ–°è¼‰å…¥ä¸¦éæ¿¾
            await loadData();
            alert(`å–®å­—ã€Œ${Word}ã€å·²æˆåŠŸå„²å­˜ï¼`);
        } catch (e) {
            console.error(e);
            alert("å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥è³‡æ–™åº«ç‹€æ…‹ã€‚");
        }
    });

    document.getElementById('playBtn').addEventListener('click', () => {
        if (filteredWords.length === 0) return;
        isPlaying = true;
        document.getElementById('playBtn').innerText = "ğŸ”Š èƒŒæ™¯æ’­æ”¾ä¸­...";
        
        // å•Ÿå‹•ç„¡è²åº•å™ªï¼Œé€™æ˜¯é˜²æ­¢ iOS èƒŒæ™¯ä¼‘çœ çš„çµ•æ‹›
        silentAudio.play().catch(e => console.log("Audio play blocked"));
        
        playLoop();
    });

    document.getElementById('stopBtn').addEventListener('click', () => {
        isPlaying = false;
        synth.cancel();
        silentAudio.pause();
        document.getElementById('playBtn').innerText = "é–‹å§‹å¾ªç’°æ’­æ”¾";
    });

    document.getElementById('excelInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data);
        const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
        for (const item of jsonData) {
            try { await db.words.put({
                Word: String(item.Word || '').trim(),
                Group: String(item.Group || 'æœªåˆ†é¡').trim(),
                Pos: String(item.Pos || '').trim(),
                Definition: String(item.Definition || '').trim(),
                Example: String(item.Example || '').trim()
            }); } catch (e) {}
        }
        loadData();
        e.target.value = "";
    });

    // å…¶ä»– UI æ§åˆ¶
    document.getElementById('groupFilter').addEventListener('change', () => { isPlaying = false; synth.cancel(); filterWords(); });
    document.getElementById('speedRange').addEventListener('change', (e) => {
        localStorage.setItem('v6_speed', e.target.value);
        document.getElementById('speedVal').innerText = e.target.value;
    });
    document.getElementById('sayExample').addEventListener('change', (e) => localStorage.setItem('v6_sayEx', e.target.checked));
    document.getElementById('autoScroll').addEventListener('change', (e) => localStorage.setItem('v6_scroll', e.target.checked));
    document.getElementById('exportBtn').addEventListener('click', async () => {
        const all = await db.words.toArray();
        const ws = XLSX.utils.json_to_sheet(all.map(w => ({Word:w.Word, Group:w.Group, Pos:w.Pos, Definition:w.Definition, Example:w.Example})));
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Words");
        XLSX.writeFile(wb, `Backup_${new Date().toLocaleDateString()}.xlsx`);
    });
    document.getElementById('toggleAddForm').addEventListener('click', () => document.getElementById('addForm').classList.toggle('hidden'));
    document.getElementById('closeFormBtn').addEventListener('click', () => document.getElementById('addForm').classList.add('hidden'));
    document.getElementById('clearBtn').addEventListener('click', async () => { if(confirm('é‡è¨­å°‡åˆªé™¤æ‰€æœ‰å–®å­—ï¼Œç¢ºå®šå—ï¼Ÿ')){ await db.words.clear(); loadData(); } });

</script>
</body>
</html>